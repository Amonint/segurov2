{% extends 'base.html' %}
{% load static %}

{% block title %}Factura {{ invoice.invoice_number }} - Sistema de Seguros UTPL{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="mb-8">
    <div class="flex justify-between items-center flex-wrap gap-4">
        <div>
            <h1 class="text-4xl font-bold text-gray-900 mb-2 flex items-center">
                <i class="bi bi-receipt mr-3 text-green-600"></i>
                Factura {{ invoice.invoice_number }}
            </h1>
            <p class="text-gray-600">Detalles completos de la factura</p>
        </div>
        <div class="flex gap-2">
            <a href="{% url 'invoices:invoice_list' %}"
                class="bg-gray-200 text-gray-700 font-semibold py-3 px-6 rounded-xl hover:bg-gray-300 transition-all duration-300">
                <i class="bi bi-arrow-left mr-2"></i> Volver
            </a>
            {% if perms.invoices.invoices_write and invoice.payment_status != 'paid' %}
            <a href="{% url 'invoices:invoice_edit' invoice.pk %}"
                class="bg-gradient-to-r from-amber-600 to-amber-700 text-white font-semibold py-3 px-6 rounded-xl hover:from-amber-700 hover:to-amber-800 transition-all duration-300">
                <i class="bi bi-pencil mr-2"></i> Editar
            </a>
            {% endif %}
            <a href="{% url 'invoices:invoice_pdf' invoice.pk %}"
                class="bg-gradient-to-r from-purple-600 to-purple-700 text-white font-semibold py-3 px-6 rounded-xl hover:from-purple-700 hover:to-purple-800 transition-all duration-300">
                <i class="bi bi-file-earmark-pdf mr-2"></i> PDF
            </a>
        </div>
    </div>
</div>

<!-- Status Alert -->
{% if is_overdue %}
<div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg mb-6">
    <div class="flex items-center">
        <i class="bi bi-exclamation-triangle text-red-600 text-2xl mr-3"></i>
        <div>
            <h3 class="text-red-800 font-bold">Factura Vencida</h3>
            <p class="text-red-700">Esta factura está vencida hace {{ days_overdue }} días</p>
        </div>
    </div>
</div>
{% endif %}

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Main Content -->
    <div class="lg:col-span-2 space-y-6">
        <!-- Invoice Info -->
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div class="bg-gradient-to-r from-green-600 to-green-700 p-6">
                <h2 class="text-white font-bold text-xl flex items-center">
                    <i class="bi bi-info-circle mr-2"></i>
                    Información de la Factura
                </h2>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-gray-500 text-sm font-semibold mb-1">Número de Factura</label>
                        <p class="text-gray-900 font-bold text-lg">{{ invoice.invoice_number }}</p>
                    </div>
                    <div>
                        <label class="block text-gray-500 text-sm font-semibold mb-1">Estado de Pago</label>
                        <span class="px-3 py-1 rounded-full text-sm font-semibold
                            {% if invoice.payment_status == 'paid' %}bg-green-100 text-green-800
                            {% elif invoice.payment_status == 'pending' %}bg-amber-100 text-amber-800
                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ invoice.get_payment_status_display }}
                        </span>
                    </div>
                    <div>
                        <label class="block text-gray-500 text-sm font-semibold mb-1">Fecha de Emisión</label>
                        <p class="text-gray-900">{{ invoice.invoice_date|date:"d/m/Y" }}</p>
                    </div>
                    <div>
                        <label class="block text-gray-500 text-sm font-semibold mb-1">Fecha de Vencimiento</label>
                        <p class="text-gray-900">{{ invoice.due_date|date:"d/m/Y" }}</p>
                    </div>
                    {% if invoice.payment_date %}
                    <div>
                        <label class="block text-gray-500 text-sm font-semibold mb-1">Fecha de Pago</label>
                        <p class="text-gray-900">{{ invoice.payment_date|date:"d/m/Y" }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Policy Info -->
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 p-6">
                <h2 class="text-white font-bold text-xl flex items-center">
                    <i class="bi bi-shield-check mr-2"></i>
                    Póliza Asociada
                </h2>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-gray-500 text-sm font-semibold mb-1">Número de Póliza</label>
                        <a href="{% url 'policies:policy_detail' invoice.policy.pk %}"
                            class="text-blue-600 hover:text-blue-800 font-bold text-lg">
                            {{ invoice.policy.policy_number }}
                        </a>
                    </div>
                    <div>
                        <label class="block text-gray-500 text-sm font-semibold mb-1">Compañía de Seguros</label>
                        <p class="text-gray-900">{{ invoice.policy.insurance_company.name }}</p>
                    </div>
                    {% if invoice.policy.broker %}
                    <div>
                        <label class="block text-gray-500 text-sm font-semibold mb-1">Corredor</label>
                        <p class="text-gray-900">{{ invoice.policy.broker.name }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Notes -->
        {% if invoice.notes %}
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div class="bg-gradient-to-r from-gray-700 to-gray-800 p-6">
                <h2 class="text-white font-bold text-xl flex items-center">
                    <i class="bi bi-chat-left-text mr-2"></i>
                    Notas
                </h2>
            </div>
            <div class="p-6">
                <p class="text-gray-700">{{ invoice.notes }}</p>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Sidebar -->
    <div class="space-y-6">
        <!-- Amount Summary -->
        <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-2xl shadow-lg p-6 border border-green-200">
            <h3 class="text-green-900 font-bold text-lg mb-4 flex items-center">
                <i class="bi bi-calculator mr-2"></i>
                Resumen de Montos
            </h3>
            <div class="space-y-3">
                <div class="flex justify-between items-center pb-2 border-b border-green-200">
                    <span class="text-green-700">Monto Base:</span>
                    <span class="text-green-900 font-semibold">${{ invoice.base_amount|floatformat:2 }}</span>
                </div>
                {% if invoice.tax_amount %}
                <div class="flex justify-between items-center pb-2 border-b border-green-200">
                    <span class="text-green-700">Impuestos:</span>
                    <span class="text-green-900 font-semibold">${{ invoice.tax_amount|floatformat:2 }}</span>
                </div>
                {% endif %}
                {% if invoice.discount_amount %}
                <div class="flex justify-between items-center pb-2 border-b border-green-200">
                    <span class="text-green-700">Descuento:</span>
                    <span class="text-red-600 font-semibold">-${{ invoice.discount_amount|floatformat:2 }}</span>
                </div>
                {% endif %}
                <div class="flex justify-between items-center pt-2">
                    <span class="text-green-900 font-bold text-lg">Total:</span>
                    <span class="text-green-900 font-bold text-2xl">${{ invoice.total_amount|floatformat:2 }}</span>
                </div>
            </div>
        </div>

        <!-- Actions -->
        {% if perms.invoices.invoices_write and invoice.payment_status != 'paid' %}
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <h3 class="text-gray-900 font-bold text-lg mb-4 flex items-center">
                <i class="bi bi-gear mr-2"></i>
                Acciones
            </h3>
            <div class="space-y-3">
                <a href="{% url 'invoices:invoice_mark_paid' invoice.pk %}"
                    class="block w-full bg-gradient-to-r from-green-600 to-green-700 text-white font-semibold py-3 px-4 rounded-xl hover:from-green-700 hover:to-green-800 transition-all duration-300 text-center">
                    <i class="bi bi-check-circle mr-2"></i> Marcar como Pagada
                </a>
                <a href="{% url 'invoices:invoice_edit' invoice.pk %}"
                    class="block w-full bg-gradient-to-r from-amber-600 to-amber-700 text-white font-semibold py-3 px-4 rounded-xl hover:from-amber-700 hover:to-amber-800 transition-all duration-300 text-center">
                    <i class="bi bi-pencil mr-2"></i> Editar Factura
                </a>
            </div>
        </div>
        {% endif %}

        <!-- Metadata -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <h3 class="text-gray-900 font-bold text-lg mb-4 flex items-center">
                <i class="bi bi-clock-history mr-2"></i>
                Información del Sistema
            </h3>
            <div class="space-y-3 text-sm">
                <div>
                    <span class="text-gray-500">Creado por:</span>
                    <p class="text-gray-900 font-semibold">{{ invoice.created_by.get_full_name }}</p>
                </div>
                <div>
                    <span class="text-gray-500">Fecha de creación:</span>
                    <p class="text-gray-900">{{ invoice.created_at|date:"d/m/Y H:i" }}</p>
                </div>
                {% if invoice.updated_at != invoice.created_at %}
                <div>
                    <span class="text-gray-500">Última actualización:</span>
                    <p class="text-gray-900">{{ invoice.updated_at|date:"d/m/Y H:i" }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}