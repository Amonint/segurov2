{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Detalle de Finiquito" %} {{ settlement.settlement_number }}{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="mb-6">
    <div class="flex justify-between items-center flex-wrap gap-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-900 flex items-center">
                <i class="bi bi-file-earmark-check mr-2 text-teal-600"></i>
                Finiquito {{ settlement.settlement_number }}
            </h1>
            <p class="text-gray-500 text-sm mt-1">Detalle del finiquito y liquidación</p>
        </div>
        <div class="flex gap-2">
            <a href="{% url 'claims:claim_detail' settlement.claim.pk %}"
                class="bg-gray-100 text-gray-700 font-medium py-2 px-4 rounded-lg hover:bg-gray-200 transition-all flex items-center text-sm">
                <i class="bi bi-arrow-left mr-1"></i> Volver al Siniestro
            </a>
            {% if settlement.status == 'pending_approval' and 'claims_write' in user.get_role_permissions %}
            <a href="{% url 'claims:claim_settlement_edit' settlement.pk %}"
                class="text-white font-semibold py-2 px-4 rounded-lg transition-all duration-300 shadow-lg flex items-center"
                style="background: linear-gradient(to right, #4a7dbb 0%, #2e5a8f 100%);">
                <i class="bi bi-pencil mr-2"></i> Editar
            </a>
            {% endif %}
        </div>
    </div>
</div>

<!-- Status Alert -->
{% if settlement.status == 'pending_approval' %}
<div class="mb-6 bg-amber-50 border-l-4 border-amber-500 p-4 rounded-r shadow-sm">
    <div class="flex">
        <div class="flex-shrink-0">
            <i class="bi bi-pencil-square text-amber-500 text-xl"></i>
        </div>
        <div class="ml-3">
            <h3 class="text-sm font-bold text-amber-800">Finiquito Pendiente de Aprobación</h3>
            <p class="text-sm text-amber-700 mt-1">
                Este finiquito está pendiente de aprobación. Revise los datos y apruébelo cuando esté listo.
            </p>
        </div>
    </div>
</div>
{% elif settlement.status == 'paid' %}
<div class="mb-6 bg-green-50 border-l-4 border-green-500 p-4 rounded-r shadow-sm">
    <div class="flex">
        <div class="flex-shrink-0">
            <i class="bi bi-check-circle-fill text-green-500 text-xl"></i>
        </div>
        <div class="ml-3">
            <h3 class="text-sm font-bold text-green-800">¡Finiquito Pagado!</h3>
            <p class="text-sm text-green-700 mt-1">
                Este finiquito ha sido pagado exitosamente.
            </p>
        </div>
    </div>
</div>
{% endif %}

<div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
    <!-- Main Content -->
    <div class="xl:col-span-2 space-y-6">

        <!-- Asset Information Card -->
        {% if settlement.claim.asset %}
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div class="bg-gradient-to-r from-purple-600 to-purple-700 p-6">
                <h2 class="text-white font-bold text-xl flex items-center">
                    <i class="bi bi-box-seam mr-2"></i>
                    Información del Bien
                </h2>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-gray-50 p-4 rounded-xl">
                        <label class="text-gray-600 text-sm font-semibold">Código del Bien</label>
                        <p class="text-gray-900 font-bold text-lg mt-1">{{ settlement.claim.asset.asset_code }}</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl">
                        <label class="text-gray-600 text-sm font-semibold">Nombre</label>
                        <p class="text-gray-900 font-bold text-lg mt-1">{{ settlement.claim.asset.name }}</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl">
                        <label class="text-gray-600 text-sm font-semibold">Tipo de Bien</label>
                        <p class="text-gray-900 font-medium mt-1">{{ settlement.claim.asset.get_asset_type_display }}
                        </p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl">
                        <label class="text-gray-600 text-sm font-semibold flex items-center">
                            <i class="bi bi-person mr-1"></i> Custodio
                        </label>
                        {% if settlement.claim.asset.custodian %}
                        <p class="text-gray-900 font-medium mt-1">{{ settlement.claim.asset.custodian.get_full_name|default:settlement.claim.asset.custodian.username }}</p>
                        {% else %}
                        <p class="text-gray-400 italic mt-1">No asignado</p>
                        {% endif %}
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl">
                        <label class="text-gray-600 text-sm font-semibold flex items-center">
                            <i class="bi bi-geo-alt mr-1"></i> Ubicación
                        </label>
                        <p class="text-gray-900 font-medium mt-1">{{ settlement.claim.asset.location|default:"-" }}</p>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-xl border border-purple-200">
                        <label class="text-purple-700 text-sm font-semibold flex items-center">
                            <i class="bi bi-cash-stack mr-1"></i> Valor del Bien
                        </label>
                        <p class="text-purple-900 font-bold text-lg mt-1">${{ settlement.claim.asset.adquisition_value|floatformat:2|default:"0.00" }}</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Policy Information Card -->
        {% if settlement.claim.policy %}
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 p-6">
                <h2 class="text-white font-bold text-xl flex items-center">
                    <i class="bi bi-file-earmark-text mr-2"></i>
                    Información de la Póliza
                </h2>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-gray-50 p-4 rounded-xl">
                        <label class="text-gray-600 text-sm font-semibold">Número de Póliza</label>
                        <a href="{% url 'policies:policy_detail' settlement.claim.policy.pk %}"
                            class="font-bold text-lg mt-1 block hover:opacity-80 transition-opacity"
                            style="color: #4a7dbb;">
                            {{ settlement.claim.policy.policy_number }}
                        </a>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl">
                        <label class="text-gray-600 text-sm font-semibold">Compañía Aseguradora</label>
                        <p class="text-gray-900 font-medium mt-1">{{ settlement.claim.policy.insurance_company.name }}
                        </p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl">
                        <label class="text-gray-600 text-sm font-semibold">Tipo de Póliza</label>
                        <p class="text-gray-900 font-medium mt-1">{{ settlement.claim.policy.subgroup|default:settlement.claim.policy.get_group_type_display }}
                        </p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl">
                        <label class="text-gray-600 text-sm font-semibold flex items-center">
                            <i class="bi bi-calendar-range mr-1"></i> Vigencia
                        </label>
                        <p class="text-gray-900 font-medium mt-1">{{ settlement.claim.policy.start_date|date:"d/m/Y" }}
                            - {{ settlement.claim.policy.end_date|date:"d/m/Y" }}</p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-200">
                        <label class="text-blue-700 text-sm font-semibold flex items-center">
                            <i class="bi bi-shield-check mr-1"></i> Suma Asegurada
                        </label>
                        <p class="text-blue-900 font-bold text-lg mt-1">${{ settlement.claim.policy.insured_value|floatformat:2 }}</p>
                    </div>
                    {% if settlement.claim.cobertura_aplicada %}
                    <div class="bg-gray-50 p-4 rounded-xl">
                        <label class="text-gray-600 text-sm font-semibold">Cobertura Aplicada</label>
                        <p class="text-gray-900 font-medium mt-1">{{ settlement.claim.cobertura_aplicada.nombre }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Claim Information Card -->
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div class="bg-gradient-to-r from-red-600 to-red-700 p-6">
                <h2 class="text-white font-bold text-xl flex items-center">
                    <i class="bi bi-exclamation-triangle mr-2"></i>
                    Información del Siniestro
                </h2>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-gray-50 p-4 rounded-xl">
                        <label class="text-gray-600 text-sm font-semibold">Número de Siniestro</label>
                        <a href="{% url 'claims:claim_detail' settlement.claim.pk %}"
                            class="font-bold text-lg mt-1 block hover:opacity-80 transition-opacity"
                            style="color: #4a7dbb;">
                            {{ settlement.claim.claim_number }}
                        </a>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl">
                        <label class="text-gray-600 text-sm font-semibold flex items-center">
                            <i class="bi bi-calendar-event mr-1"></i> Fecha del Incidente
                        </label>
                        <p class="text-gray-900 font-bold text-lg mt-1">{{ settlement.claim.fecha_siniestro|date:"d/m/Y" }}</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl">
                        <label class="text-gray-600 text-sm font-semibold flex items-center">
                            <i class="bi bi-geo-alt mr-1"></i> Ubicación
                        </label>
                        <p class="text-gray-900 font-medium mt-1">{{ settlement.claim.ubicacion_detallada|truncatewords:15 }}</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl">
                        <label class="text-gray-600 text-sm font-semibold">Número de Reclamo</label>
                        <p class="text-gray-900 font-medium mt-1">{{ settlement.claim_reference_number }}</p>
                    </div>
                </div>

                <!-- Cause Description -->
                <div class="mt-4 bg-red-50 border border-red-200 rounded-xl p-4">
                    <label class="text-red-700 text-sm font-semibold">Causa del Siniestro</label>
                    <p class="text-gray-900 mt-2 leading-relaxed">{{ settlement.claim.causa }}</p>
                </div>
            </div>
        </div>

        <!-- Settlement Details Card -->
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div class="bg-gradient-to-r p-6" style="background: linear-gradient(to right, #4a7dbb 0%, #2e5a8f 100%);">
                <h2 class="text-white font-bold text-xl flex items-center">
                    <i class="bi bi-clock-history mr-2"></i>
                    Historial del Finiquito
                </h2>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-gray-50 p-4 rounded-xl">
                        <label class="text-gray-600 text-sm font-semibold flex items-center">
                            <i class="bi bi-calendar-plus mr-1"></i> Fecha de Creación
                        </label>
                        <p class="text-gray-900 font-medium mt-1">{{ settlement.created_at|date:"d/m/Y H:i" }}</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl">
                        <label class="text-gray-600 text-sm font-semibold flex items-center">
                            <i class="bi bi-person mr-1"></i> Creado por
                        </label>
                        <p class="text-gray-900 font-medium mt-1">{{ settlement.created_by.get_full_name|default:"-" }}
                        </p>
                    </div>
                    {% if settlement.approved_by %}
                    <div class="bg-green-50 p-4 rounded-xl border border-green-200">
                        <label class="text-green-700 text-sm font-semibold flex items-center">
                            <i class="bi bi-check-circle mr-1"></i> Aprobado por
                        </label>
                        <p class="text-green-900 font-medium mt-1">{{ settlement.approved_by.get_full_name }}</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-xl border border-green-200">
                        <label class="text-green-700 text-sm font-semibold flex items-center">
                            <i class="bi bi-calendar-check mr-1"></i> Fecha de Aprobación
                        </label>
                        <p class="text-green-900 font-medium mt-1">{{ settlement.approved_at|date:"d/m/Y H:i" }}</p>
                    </div>
                    {% endif %}
                    {% if settlement.signed_date %}
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-200">
                        <label class="text-blue-700 text-sm font-semibold flex items-center">
                            <i class="bi bi-vector-pen mr-1"></i> Fecha de Firma
                        </label>
                        <p class="text-blue-900 font-medium mt-1">{{ settlement.signed_date|date:"d/m/Y" }}</p>
                    </div>
                    {% endif %}
                    {% if settlement.payment_date %}
                    <div class="bg-teal-50 p-4 rounded-xl border border-teal-200">
                        <label class="text-teal-700 text-sm font-semibold flex items-center">
                            <i class="bi bi-cash-coin mr-1"></i> Fecha de Pago
                        </label>
                        <p class="text-teal-900 font-medium mt-1">{{ settlement.payment_date|date:"d/m/Y" }}</p>
                    </div>
                    {% endif %}
                </div>
                {% if settlement.payment_reference %}
                <div class="mt-4 bg-teal-50 border border-teal-200 rounded-xl p-4">
                    <label class="text-teal-700 text-sm font-semibold">Referencia de Pago</label>
                    <p class="text-teal-900 font-mono text-lg mt-1">{{ settlement.payment_reference }}</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Document Card -->
        {% if settlement.settlement_document %}
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div class="bg-gradient-to-r from-green-600 to-green-700 p-6">
                <h2 class="text-white font-bold text-xl flex items-center">
                    <i class="bi bi-file-earmark-pdf mr-2"></i>
                    Documento de Finiquito
                </h2>
            </div>
            <div class="p-6 flex justify-center gap-4">
                <a href="{{ settlement.settlement_document.url }}" target="_blank"
                    class="bg-green-100 text-green-700 font-semibold py-3 px-6 rounded-xl hover:bg-green-200 transition-all duration-300 flex items-center">
                    <i class="bi bi-eye mr-2"></i> Ver Documento
                </a>
                <a href="{{ settlement.settlement_document.url }}" download
                    class="bg-gray-100 text-gray-700 font-semibold py-3 px-6 rounded-xl hover:bg-gray-200 transition-all duration-300 flex items-center">
                    <i class="bi bi-download mr-2"></i> Descargar
                </a>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Sidebar -->
    <div class="space-y-6 xl:sticky xl:top-24 h-fit">
        <!-- Financial Summary -->
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div class="bg-gradient-to-r from-teal-600 to-teal-700 p-6">
                <div class="flex justify-between items-center">
                    <h3 class="text-white font-bold text-lg flex items-center">
                        <i class="bi bi-calculator mr-2"></i>
                        Resumen Financiero
                    </h3>
                    <span class="px-3 py-1 rounded-full text-xs font-bold
                        {% if settlement.status == 'draft' %}bg-gray-500 text-white
                        {% elif settlement.status == 'pending_approval' %}bg-amber-500 text-white
                        {% elif settlement.status == 'approved' %}bg-cyan-500 text-white
                        {% elif settlement.status == 'signed' %}bg-blue-500 text-white
                        {% elif settlement.status == 'paid' %}bg-green-500 text-white
                        {% elif settlement.status == 'rejected' %}bg-red-500 text-white
                        {% else %}bg-gray-500 text-white{% endif %}">
                        {{ settlement.get_status_display }}
                    </span>
                </div>
            </div>
            <div class="p-6">
                <!-- Financial Breakdown -->
                <div class="space-y-4">
                    <div class="flex justify-between items-center py-3 border-b border-gray-100">
                        <span class="text-gray-600 font-medium">Valor Total del Siniestro</span>
                        <span class="text-gray-900 font-semibold text-lg">${{ settlement.total_claim_amount|floatformat:2 }}</span>
                    </div>
                    <div class="flex justify-between items-center py-3 border-b border-gray-100">
                        <span class="text-gray-600 font-medium">
                            <i class="bi bi-dash-circle text-red-500 mr-1"></i> Deducible
                        </span>
                        <span class="text-red-600 font-semibold text-lg">- ${{ settlement.deductible_amount|floatformat:2 }}</span>
                    </div>
                    <div class="flex justify-between items-center py-3 border-b border-gray-100">
                        <span class="text-gray-600 font-medium">
                            <i class="bi bi-dash-circle text-amber-500 mr-1"></i> Depreciación
                        </span>
                        <span class="text-amber-600 font-semibold text-lg">- ${{ settlement.depreciation_amount|floatformat:2 }}</span>
                    </div>
                </div>

                <!-- Final Amount -->
                <div
                    class="mt-6 bg-gradient-to-br from-green-50 to-green-100 border-2 border-green-300 rounded-xl p-6 text-center">
                    <p class="text-green-700 text-sm font-semibold mb-2">Valor Final a Pagar</p>
                    <h2 class="text-5xl font-bold text-green-600">${{ settlement.final_payment_amount|floatformat:2 }}</h2>
                </div>
            </div>
        </div>

        <!-- Actions Panel -->
        {% if 'claims_write' in user.get_role_permissions %}
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div class="bg-gradient-to-r p-6" style="background: linear-gradient(to right, #4a7dbb 0%, #2e5a8f 100%);">
                <h3 class="text-white font-bold text-lg flex items-center">
                    <i class="bi bi-tools mr-2"></i>
                    Acciones
                </h3>
            </div>
            <div class="p-6 space-y-3">
                {% if settlement.status == 'pending_approval' %}
                <form method="post" action="{% url 'claims:claim_settlement_approve' settlement.pk %}">
                    {% csrf_token %}
                    <button type="submit"
                        class="w-full bg-gradient-to-r from-green-600 to-green-700 text-white font-semibold py-3 px-4 rounded-xl hover:from-green-700 hover:to-green-800 transition-all duration-300 flex items-center justify-center"
                        onclick="return confirm('¿Está seguro de aprobar este finiquito?');">
                        <i class="bi bi-check-circle-fill mr-2"></i> Aprobar Finiquito
                    </button>
                </form>
                <a href="{% url 'claims:claim_settlement_edit' settlement.pk %}"
                    class="block w-full text-center bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-3 px-4 rounded-xl transition-all duration-300 border-2 border-gray-200">
                    <i class="bi bi-pencil mr-2"></i> Editar Finiquito
                </a>
                {% endif %}

                {% if settlement.status == 'approved' %}
                <form method="post" action="{% url 'claims:claim_settlement_sign' settlement.pk %}">
                    {% csrf_token %}
                    <button type="submit"
                        class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white font-semibold py-3 px-4 rounded-xl hover:from-blue-700 hover:to-blue-800 transition-all duration-300 flex items-center justify-center">
                        <i class="bi bi-vector-pen mr-2"></i> Marcar como Firmado
                    </button>
                </form>
                {% endif %}

                {% if settlement.status == 'signed' %}
                <button type="button" onclick="document.getElementById('paymentModal').classList.remove('hidden')"
                    class="w-full bg-gradient-to-r from-teal-600 to-teal-700 text-white font-semibold py-3 px-4 rounded-xl hover:from-teal-700 hover:to-teal-800 transition-all duration-300 flex items-center justify-center">
                    <i class="bi bi-cash-coin mr-2"></i> Registrar Pago
                </button>
                {% endif %}

                <!-- Back to Claim -->
                <a href="{% url 'claims:claim_detail' settlement.claim.pk %}"
                    class="block w-full text-center bg-gray-50 hover:bg-gray-100 text-gray-700 font-medium py-3 px-4 rounded-xl transition-all duration-300 mt-4">
                    <i class="bi bi-arrow-left mr-2"></i> Ver Siniestro Completo
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Payment Modal -->
<div id="paymentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 overflow-hidden">
        <div class="bg-gradient-to-r from-teal-600 to-teal-700 p-6">
            <h3 class="text-white font-bold text-xl flex items-center">
                <i class="bi bi-cash-coin mr-2"></i>
                Registrar Pago
            </h3>
        </div>
        <form method="post" action="{% url 'claims:claim_settlement_pay' settlement.pk %}" class="p-6">
            {% csrf_token %}
            <div class="mb-4">
                <label class="block text-gray-700 font-semibold mb-2">Referencia de Pago</label>
                <input type="text" name="payment_reference" required
                    class="w-full border border-gray-300 rounded-xl p-3 focus:ring-2 focus:ring-teal-500 focus:border-teal-500"
                    placeholder="Ingrese la referencia del pago...">
            </div>
            <div class="flex gap-3">
                <button type="button" onclick="document.getElementById('paymentModal').classList.add('hidden')"
                    class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 px-4 rounded-xl transition-all">
                    Cancelar
                </button>
                <button type="submit"
                    class="flex-1 bg-gradient-to-r from-teal-600 to-teal-700 text-white font-semibold py-3 px-4 rounded-xl hover:from-teal-700 hover:to-teal-800 transition-all">
                    Confirmar Pago
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Close modal on escape key
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            document.getElementById('paymentModal').classList.add('hidden');
        }
    });

    // Close modal on backdrop click
    document.getElementById('paymentModal').addEventListener('click', function (e) {
        if (e.target === this) {
            this.classList.add('hidden');
        }
    });
</script>
{% endblock %}




