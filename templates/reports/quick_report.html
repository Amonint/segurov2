{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}Generar Reporte Rápido | Sistema de Seguros{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-2xl mx-auto">
        <!-- Header -->
        <div class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-800">Generar Reporte Rápido</h1>
            <p class="text-gray-600 mt-2">Seleccione los criterios para generar un reporte instantáneo sin guardarlo.
            </p>
        </div>

        <!-- Form Card -->
        <div class="bg-white rounded-xl shadow-lg p-6 md:p-8">
            <form method="post" action="{% url 'reports:quick_report' %}" novalidate class="space-y-6">
                {% csrf_token %}

                {% if form.non_field_errors %}
                <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="bi bi-exclamation-circle text-red-500"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-red-700">
                                {% for error in form.non_field_errors %}
                                {{ error }}<br>
                                {% endfor %}
                            </p>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Report Type & Format -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="{{ form.report_type.id_for_label }}"
                            class="block text-sm font-medium text-gray-700 mb-1">
                            {{ form.report_type.label }} <span class="text-red-500">*</span>
                        </label>
                        <select name="{{ form.report_type.name }}" id="{{ form.report_type.id_for_label }}"
                            class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500">
                            {% for value, text in form.report_type.field.choices %}
                            <option value="{{ value }}" {% if form.report_type.value==value %}selected{% endif %}>{{
                                text }}</option>
                            {% endfor %}
                        </select>
                        {% if form.report_type.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ form.report_type.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label for="{{ form.export_format.id_for_label }}"
                            class="block text-sm font-medium text-gray-700 mb-1">
                            {{ form.export_format.label }}
                        </label>
                        <select name="{{ form.export_format.name }}" id="{{ form.export_format.id_for_label }}"
                            class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500">
                            {% for value, text in form.export_format.field.choices %}
                            <option value="{{ value }}" {% if form.export_format.value==value %}selected{% endif %}>{{
                                text }}</option>
                            {% endfor %}
                        </select>
                        {% if form.export_format.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ form.export_format.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>

                <hr class="border-gray-200 my-4">

                <!-- Date Filters -->
                <div>
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Filtrar por Fecha</h3>

                    <div class="mb-4">
                        <label for="{{ form.date_range.id_for_label }}"
                            class="block text-sm font-medium text-gray-700 mb-1">
                            {{ form.date_range.label }} <span class="text-gray-400 text-xs">(Opción rápida)</span>
                        </label>
                        <select name="{{ form.date_range.name }}" id="{{ form.date_range.id_for_label }}"
                            class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500 bg-gray-50">
                            {% for value, text in form.date_range.field.choices %}
                            <option value="{{ value }}" {% if form.date_range.value==value %}selected{% endif %}>{{ text
                                }}</option>
                            {% endfor %}
                        </select>
                        {% if form.date_range.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ form.date_range.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <div class="flex items-center justify-center my-4">
                        <span class="px-3 bg-white text-gray-500 text-sm">O especificar fechas personalizadas</span>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="{{ form.custom_date_from.id_for_label }}"
                                class="block text-sm font-medium text-gray-700 mb-1">
                                {{ form.custom_date_from.label }}
                            </label>
                            <input type="date" name="{{ form.custom_date_from.name }}"
                                id="{{ form.custom_date_from.id_for_label }}"
                                value="{{ form.custom_date_from.value|default:'' }}"
                                class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500">
                            {% if form.custom_date_from.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.custom_date_from.errors.0 }}</p>
                            {% endif %}
                        </div>
                        <div>
                            <label for="{{ form.custom_date_to.id_for_label }}"
                                class="block text-sm font-medium text-gray-700 mb-1">
                                {{ form.custom_date_to.label }}
                            </label>
                            <input type="date" name="{{ form.custom_date_to.name }}"
                                id="{{ form.custom_date_to.id_for_label }}"
                                value="{{ form.custom_date_to.value|default:'' }}"
                                class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500">
                            {% if form.custom_date_to.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.custom_date_to.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex items-center justify-end space-x-3 pt-6 border-t border-gray-100">
                    <a href="{% url 'reports:report_list' %}"
                        class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                        Cancelar
                    </a>
                    <button type="submit"
                        class="px-6 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all shadow-md flex items-center">
                        <i class="bi bi-file-earmark-text mr-2"></i>
                        Generar Reporte
                    </button>
                </div>
            </form>
        </div>

        <!-- Quick Links -->
        <div class="mt-8 text-center text-sm text-gray-500">
            <p>¿Necesitas guardar esta configuración?</p>
            <a href="{% url 'reports:report_create' %}"
                class="text-blue-600 hover:underline hover:text-blue-800 font-medium mt-1 inline-block">
                Crear Reporte Guardado &rarr;
            </a>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const dateRangeSelect = document.getElementById('{{ form.date_range.id_for_label }}');
        const customDateFrom = document.getElementById('{{ form.custom_date_from.id_for_label }}');
        const customDateTo = document.getElementById('{{ form.custom_date_to.id_for_label }}');

        // Logic to clear custom dates when a range is selected
        dateRangeSelect.addEventListener('change', function () {
            if (this.value) {
                customDateFrom.value = '';
                customDateTo.value = '';
                customDateFrom.disabled = true;
                customDateTo.disabled = true;
                customDateFrom.classList.add('bg-gray-100');
                customDateTo.classList.add('bg-gray-100');
            } else {
                customDateFrom.disabled = false;
                customDateTo.disabled = false;
                customDateFrom.classList.remove('bg-gray-100');
                customDateTo.classList.remove('bg-gray-100');
            }
        });

        // Trigger change on load to set initial state
        dateRangeSelect.dispatchEvent(new Event('change'));

        // If custom dates are modified, clear logic could be added here if needed to clear range,
        // but current logic prioritizes range if selected.
    });
</script>
{% endblock %}